name: GitHub Actions Demo

on:
  push:

jobs:
  # Build-Actions:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository code
  #       uses: actions/checkout@v2
  #     - name: Build the Docker image
  #       run: |
  #         NAMESPACE=nikasaih/test-ci/test
  #         IMAGE_NAME=iam
  #         docker build -t ghcr.io/$NAMESPACE/$IMAGE_NAME:latest .
  #     - name: login to registry
  #       run: |
  #         CR_PAT=${{ secrets.REGISTRYTOKEN }}
  #         echo $CR_PAT | docker login ghcr.io -u USERNAME --password-stdin
  #     - name: Push Docker image to registry
  #       run: |
  #         NAMESPACE=nikasaih/test-ci/test
  #         IMAGE_NAME=iam
  #         docker push ghcr.io/$NAMESPACE/$IMAGE_NAME:latest

  Deploy-Action:
      runs-on: ubuntu-latest
      # needs: Build-Actions
      steps:
        - name: Connect to host and update image
          env:
            PROD_SSH_KEY: ${{secrets.PROD_SSH_KEY}}
            PROD_SSH_KEY_FILE: ~/.ssh/jean
            PROD_HOST: ${{ secrets.PROD_HOST }}
            PROD_USER: ${{ secrets.PROD_USER }}
          run: |  
            mkdir -p ~/.ssh
            echo $PROD_SSH_KEY > $PROD_SSH_KEY_FILE
            chmod 600 $PROD_SSH_KEY_FILE
            echo $PROD_SSH_KEY_FILE
            echo $PROD_HOST
            echo $PROD_USER

            ssh $PROD_USER@$PROD_HOST -i $PROD_SSH_KEY_FILE "sh /updateIamImage.sh"
